{{- $s := lookup "v1" "Secret" .Release.Namespace (include "patchmon.fullname" .) -}}

{{- $oldPg := "" -}}
{{- if and $s (index $s "data") (index (index $s "data") "POSTGRES_PASSWORD") -}}
{{- $oldPg = (index (index $s "data") "POSTGRES_PASSWORD") | b64dec -}}
{{- end -}}

{{- $oldJwt := "" -}}
{{- if and $s (index $s "data") (index (index $s "data") "JWT_SECRET") -}}
{{- $oldJwt = (index (index $s "data") "JWT_SECRET") | b64dec -}}
{{- end -}}

{{- $oldOidc := "" -}}
{{- if and $s (index $s "data") (index (index $s "data") "OIDC_CLIENT_SECRET") -}}
{{- $oldOidc = (index (index $s "data") "OIDC_CLIENT_SECRET") | b64dec -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "patchmon.fullname" . }}
  labels:
    {{- include "patchmon.labels" . | nindent 4 }}
type: Opaque
stringData:
{{- if and (eq .Values.database.mode "internal") (not .Values.postgres.auth.existingSecret) }}
  POSTGRES_PASSWORD: {{ default (randAlphaNum 32) $oldPg | quote }}
{{- end }}
  JWT_SECRET: {{ default (randAlphaNum 64) (default $oldJwt .Values.patchmon.jwt.secret) | quote }}
{{- /*
    Only store OIDC_CLIENT_SECRET in this chart Secret when:
    - OIDC is enabled
    - user is NOT using an existing secret reference
*/ -}}
{{- if and .Values.patchmon.oidc.enabled (not (and .Values.patchmon.oidc.clientSecretFromSecret.name (ne .Values.patchmon.oidc.clientSecretFromSecret.name ""))) }}
  OIDC_CLIENT_SECRET: {{ default $oldOidc .Values.patchmon.oidc.clientSecret | required "patchmon.oidc.clientSecret is required when oidc is enabled and clientSecretFromSecret.name is not set" | quote }}
{{- end }}
